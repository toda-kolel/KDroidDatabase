# ğŸ“„ JSON Policy Contribution Guide

âœ¨ **We accept pull requests *only* containing JSON policy files.** No code changes or Kotlin sources.

---

```text
AppPolicy
â”œâ”€â”€ FixedPolicy
â”‚   â”œâ”€â”€ "type": "Fixed"
â”‚   â”œâ”€â”€ networkPolicy
â”‚   â”‚   â”œâ”€â”€ mode: FULL_OPEN | BLACKLIST | WHITELIST | LOCAL_ONLY
â”‚   â”‚   â””â”€â”€ spec: None | HostList{hostsâ€¦}
â”‚   â””â”€â”€ detectionRules [â€¦]
â”‚
â”œâ”€â”€ ModeBasedPolicy
â”‚   â”œâ”€â”€ "type": "ModeBased"
â”‚   â”œâ”€â”€ modePolicies
â”‚   â”‚   â”œâ”€â”€ OFFLINE â†’ NetworkPolicy{â€¦}
â”‚   â”‚   â”œâ”€â”€ GPS_ONLY â†’ NetworkPolicy{â€¦}
â”‚   â”‚   â”œâ”€â”€ GPS_AND_MAIL â†’ NetworkPolicy{â€¦}
â”‚   â”‚   â”œâ”€â”€ REDUCED_RISK â†’ NetworkPolicy{â€¦}
â”‚   â”‚   â””â”€â”€ MOST_OPEN â†’ NetworkPolicy{â€¦}
â”‚   â””â”€â”€ detectionRules [â€¦]
â”‚
â””â”€â”€ MultiModePolicy
    â”œâ”€â”€ "type": "MultiMode"
    â”œâ”€â”€ modeVariants
    â”‚   â”œâ”€â”€ userMode: GPS_ONLY
    â”‚   â”‚   â”œâ”€â”€ variants
    â”‚   â”‚   â”‚   â”œâ”€â”€ id: "strict",   policy: {mode: LOCAL_ONLY}
    â”‚   â”‚   â”‚   â””â”€â”€ id: "balanced", policy: {mode: WHITELIST, spec: HostList[â€¦]}
    â”‚   â”‚   â””â”€â”€ defaultVariantId: "balanced"
    â”‚   â””â”€â”€ userMode: MOST_OPEN
    â”‚       â”œâ”€â”€ variants
    â”‚       â”‚   â””â”€â”€ id: "open", policy: {mode: FULL_OPEN}
    â”‚       â””â”€â”€ defaultVariantId: "open"
    â””â”€â”€ detectionRules [â€¦]
```

## ğŸ—‚ï¸ Directory Structure

Place your JSON file under:

```
app-policies/<category>/<packageName>.json
```

Example:

```
app-policies/navigation/com.example.app.json
```

Each category folder (e.g., `communication`, `navigation`, `video`) helps avoid merge conflicts and keeps things tidy. ğŸš€

---

## ğŸ“ Supported Policy Types & Templates

Below are the three policy types. Copy the template that matches your use case and fill in your data.

### 1ï¸âƒ£ FixedPolicy

Use when the same network rules apply to all modes.

```json
{
  "type": "Fixed",
  "packageName": "org.signal",
  "category": "COMMUNICATION",
  "minimumVersionCode": 0,
  "networkPolicy": {
    "mode": "WHITELIST",
    "spec": {
      "type": "HostList",
      "hosts": ["signal.org"]
    }
  }
}
```

### 2ï¸âƒ£ ModeBasedPolicy

Use when you need different rules per user mode.

```json
{
  "type": "ModeBased",
  "packageName": "com.whatsapp",
  "category": "COMMUNICATION",
  "minimumVersionCode": 100,
  "modePolicies": {
    "OFFLINE":  { "mode": "LOCAL_ONLY" },
    "GPS_ONLY": {
      "mode": "WHITELIST",
      "spec": { "type": "HostList", "hosts": ["whatsapp.com"] }
    },
    "MOST_OPEN": { "mode": "FULL_OPEN" }
  }
}
```

### 3ï¸âƒ£ MultiModePolicy

Use when each user mode has multiple variants, each with its own rules and optional activity/node detections.

```json
{
  "type": "MultiMode",
  "packageName": "com.whatsapp",
  "category": "COMMUNICATION",
  "minimumVersionCode": 0,
  "modeVariants": [
    {
      "userMode": "MOST_OPEN",
      "variants": [
        {
          "id": "open",
          "label": "Fully open",
          "policy": {
            "mode": "FULL_OPEN"
          }
        },
        {
          "id": "restricted",
          "label": "Only messages, no photos, videos and calling",
          "policy": {
            "mode": "WHITELIST",
            "spec": {
              "type": "HostList",
              "hosts": [
                "v.whatsapp.net",
                "static.whatsapp.net",
                "firebaseinstallations.googleapis.com",
                "time.android.com",
                "dit.whatsapp.net",
                "e1.whatsapp.net",
                "mmg.whatsapp.net",
                "g.whatsapp.net"
              ]
            }
          }
        },
        {
          "id": "block_groups",
          "label": "Block groups",
          "policy": {
            "mode": "FULL_OPEN"
          },
          "detectionRules": [
            {
              "type": "NODE",
              "targets": [
                "TODO"
              ],
              "condition": "ONLY_IF",
              "action": "KILL_APP"
            }
          ],
          "overrideDefaultRules" : false,
          "configurationRequired" : true,
          "configurationKey" : "whatsapp_groups_prefs"
        }
      ],
      "defaultVariantId": "open"
    }
  ],
  "detectionRules": [
    {
      "type": "NODE",
      "targets": [
        "com.whatsapp:id/newsletter_quick_forwarding_pill_container_key"
      ],
      "condition": "ONLY_IF",
      "action": "KILL_APP",
      "desc": "Kill app when entering on WhatsApp Update channel"
    }
  ]
}
```

* `detectionRules` at the root apply across all variants.
* Within each variant:

    * `detectionRules`: rules specific to that variant.
    * `overrideDefaultRules` (boolean):

        * `true` (default): only variant rules apply.
        * `false`: merge root rules + variant rules (set explicitly).

---

ğŸ§© About configurationRequired and configurationKey
Some MultiModePolicy variants may require user configuration (for example, specifying allowed or blocked WhatsApp groups). To support this, a variant can define:

configurationRequired: true â†’ Signals the app that this variant needs extra user input (e.g., group names).

configurationKey: "..." â†’ A unique key used to link user input to the policy variant.

The app is expected to query this configuration during enforcement. The backend does not define valuesâ€”only the key.



## âœ… Checklist Before Submitting

1. ğŸ” **Validate JSON** with a linter (e.g., [jsonlint.com](https://jsonlint.com/)).
2. ğŸ“‚ **Place** your file under the correct category folder.
3. ğŸ“œ **Commit only** the JSON fileâ€”no code or docs changes.
4. ğŸ“ **PR title** should clearly state the app package and policy type.

CI will reject invalid JSON or misplaced files. Good luck! ğŸ™Œ
